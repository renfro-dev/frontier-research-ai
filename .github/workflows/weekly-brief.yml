name: Weekly Briefs Pipeline (Systems Thinking & Context Orchestration)

on:
  # Run every Monday at 11:00 AM PST (7:00 PM UTC / 2:00 PM EST)
  schedule:
    - cron: '0 19 * * 1'

  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYY-MM-DD) - optional, defaults to last Monday'
        required: false
        type: string
      end_date:
        description: 'End date (YYYY-MM-DD) - optional, defaults to last Sunday'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-weekly-brief:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Calculate date range
        id: dates
        run: |
          if [ -n "${{ github.event.inputs.start_date }}" ]; then
            echo "start_date=${{ github.event.inputs.start_date }}" >> $GITHUB_OUTPUT
            echo "end_date=${{ github.event.inputs.end_date }}" >> $GITHUB_OUTPUT
          else
            # Calculate last 7 days (from 7 days ago to today)
            # Include today since analysis runs during this workflow and creates
            # summaries with analyzed_at = today
            end_date=$(date +%Y-%m-%d)
            start_date=$(date -d "7 days ago" +%Y-%m-%d)
            echo "start_date=$start_date" >> $GITHUB_OUTPUT
            echo "end_date=$end_date" >> $GITHUB_OUTPUT
          fi
          echo "Calculated date range: $start_date to $end_date"
      
      - name: Run Ingest Agent
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üì• Running Ingest Agent..."
          python3 scripts/ingest_agent.py --fetch-full-content
      
      - name: Run Extraction Agent
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üîç Running Extraction Agent..."
          python3 scripts/extraction_agent.py
      
      - name: Run Embedding Agent
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üßÆ Running Embedding Agent..."
          python3 scripts/embedding_agent.py
      
      - name: Run Analysis Agent
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ü§ñ Running Analysis Agent..."
          python3 scripts/analysis_agent.py

      - name: Run Systems Thinking Synthesis Agent
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "‚úçÔ∏è Running Systems Thinking Synthesis Agent..."
          echo "Date range: ${{ steps.dates.outputs.start_date }} to ${{ steps.dates.outputs.end_date }}"
          python3 scripts/synthesis_agent.py \
            --start-date ${{ steps.dates.outputs.start_date }} \
            --end-date ${{ steps.dates.outputs.end_date }}

      - name: Run Context Orchestration Synthesis Agent
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üéØ Running Context Orchestration Synthesis Agent..."
          python3 scripts/synthesis_agent_orchestration.py \
            --start-date ${{ steps.dates.outputs.start_date }} \
            --end-date ${{ steps.dates.outputs.end_date }}

      - name: Commit generated briefs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add briefs/
          git diff --staged --quiet || git commit -m "ü§ñ Auto-generated weekly briefs for ${{ steps.dates.outputs.start_date }} to ${{ steps.dates.outputs.end_date }}"
          git push
        continue-on-error: true

      - name: Summary
        run: |
          echo "‚úÖ Weekly briefs pipeline completed!"
          echo "üìÖ Date range: ${{ steps.dates.outputs.start_date }} to ${{ steps.dates.outputs.end_date }}"
          echo "üìä Generated:"
          echo "  - Systems Thinking Brief ‚Üí briefs/systems_thinking/"
          echo "  - Context Orchestration Brief ‚Üí briefs/context_orchestration/"
